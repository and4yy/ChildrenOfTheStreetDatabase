<!DOCTYPE html>
<html>
	<head>
  		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script type='text/javascript' src="https://chriszarate.github.io/sheetrock/dist/sheetrock.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
		
		<script type='text/javascript'>//<![CDATA[
			//var malformedparentToolkitSheet = 'https://docs.google.com/spreadsheets/d/1l2jeO_mukPEyrXwGtNn56xM-hGbas-WMwZ7So3cOAIc/edit#gid=0';
			var parentToolkitSheet = 'https://docs.google.com/spreadsheets/d/1RHCgt5w5KlqucNdKVPP25uUovFu2vQIZsZml1dzZPR0/edit#gid=0';
			var filterSheet = 'https://docs.google.com/spreadsheets/d/1RHCgt5w5KlqucNdKVPP25uUovFu2vQIZsZml1dzZPR0/edit#gid=1597681109';
		
			// Register template for resources
			var resourceTemplate;
			
			// When querying the spreadsheet we must use column letters. Map the column names of our filters to their "letter"
			var filterColMapping = {
				"Service Location": ["H"],
				"Service Type": ["G"],
				"Service Region": ["I"]
			};

			function LoadResources(filterType, filterValue)
			{			
				var searchQuery = "select A,B,C,D,E,F,G,H,I where " + filterColMapping[filterType] + " like '%" + filterValue + "%' order by A";
						
				//var labelsArray = ["Organization", "Program", "Description", "Website", "Phone Number", "Email", "Service Type", "Service Location", "Service Region"];
			
				$('#loadingIcon').show();
				
				// Load up the list of resources that match the filters
				$('#resourceBody').empty().sheetrock({
					url: parentToolkitSheet,
					query: searchQuery,
					//labels: labelsArray,
					loading: $('#loadingIcon'),
					rowTemplate: resourceTemplate,
					callback: SheetrockHandler,
					rowGroups: false
				});
				
				$('#loadingIcon').hide();
			}

			function SheetrockHandler(Error, Options, Response)
			{
				if (Error != null)
				{
					$('#errorMessage').show();
				}
			}

			$(window).load(function(){				
				$('#regionFilter').change(function() {
					LoadResources("Service Region", $(this).val());
				});
			
				$('#cityFilter').change(function() {
					LoadResources("Service Location", $(this).val());
				});
			
				$('#typeFilter').change(function() {
					LoadResources("Service Type", $(this).val());
				});
					
				// Register our Handlebars templates
				var RegionTemplate = Handlebars.compile($('#region-template').html());
				var CityTemplate = Handlebars.compile($('#city-template').html());
				var TypeTemplate = Handlebars.compile($('#type-template').html());
				// Compile the test template
				resourceTemplate = Handlebars.compile($('#resourceTemplate').html());
		
				// Populate our select lists with filter options	
				$('#regionFilter').sheetrock({
					url: filterSheet,
					query: "select A WHERE A != ' '",
					rowTemplate: RegionTemplate,
					  callback: SheetrockHandler
				}).append($("<option></option>"));

				$('#cityFilter').sheetrock({
					url: filterSheet,
					query: "select B",
					rowTemplate: CityTemplate,
					  callback: SheetrockHandler
				}).append($("<option></option>"));

				$('#typeFilter').sheetrock({
					url: filterSheet,
					query: "select C",
					rowTemplate: TypeTemplate,
					  callback: SheetrockHandler
				}).append($("<option></option>"));
			});//]]> 
		</script>	
		
		<style type="text/css">
			.field label {
				width: 200px;
			}
			select {
				width: 200px;
			}
			.table-striped > tbody > tr:nth-of-type(2n+1) {
				background-color: #F8C0EB;
			}
			
		</style>
	</head>
	<body>	
		<div id="loadingIcon" style="float:right;padding:10px;color:white;background-color:#CF0072;display:none;">
			LOADING...
		</div>
		
		<div class="field">
			<label for="regionFilter">Search by Region</label>
			<select id="regionFilter">
				<script id="region-template" type="text/x-handlebars-template">
					<option value="{{cells.Regions}}">{{cells.Regions}}</option>
				</script>
			</select>
		</div>
		
		<div class="field">
			<label for="cityFilter">Search by City</label>
			<select id="cityFilter">
				<script id="city-template" type="text/x-handlebars-template">
					<option value="{{cells.Cities}}">{{cells.Cities}}</option>
				</script>
			</select>
		</div>

		<div class="field">
			<label for="typeFilter">Search by Service Type</label>
			<select id="typeFilter">
				<script id="type-template" type="text/x-handlebars-template">
					<option value="{{cells.Types}}">{{cells.Types}}</option>
				</script>
			</select>
		</div>
		
		<hr />
		
		<div id="errorMessage" style="display:none;border:4px solid red;">
			<p>There was an error loading the database</p>
		</div>
		
		<p>Resources available based on your selection:</p>
		<table id="resourceList" class="table table-condensed table-striped">
			<tr>
				<th style="width:150px;">Organization</th>
				<th style="width:150px;">Program</th>
				<th>Description</th>
				<th style="width:150px;">Website</th>
				<th>Phone</th>
				<th>Email</th>
				<th>Services</th>
				<th>Location</th>
				<th>Region</th>
			</tr>
			<tbody id="resourceBody">
				<script id="resourceTemplate" type="text/x-handlebars-template">
					<tr>
						<td>{{cells.Organization}}</td>
						<td>{{cells.Program}}</td>
						<td>{{cells.Description}}</td>
						<td><a href="{{cells.Website}}">{{cells.Website}}</a></td>
						<td>{{cells.Phone}}</td>
						<td><a href="mailto:{{cells.Email}}">{{cells.Email}}</a></td>
						<td>{{cells.Services}}</td>
						<td>{{cells.Location}}</td>
						<td>{{cells.Region}}</td>
					</tr>
				</script>
			</tbody>			
		</table>
	</body>
		
</html>

